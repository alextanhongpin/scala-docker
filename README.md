# scala-docker

Goal: Setup a simple akka http project and deploy it to Docker with the smallest image possible.

## Setup

The following command will setup a new Akka HTTP web application project.

```bash
$ sbt -Dsbt.version=0.13.15 new https://github.com/akka/akka-http-quickstart-scala.g8
```

Output:

```bash
WARN: No sbt.version set in project/build.properties, base directory: /Users/alextanhongpin/Documents/scala/scala-docker
[warn] Executing in batch mode.
[warn]   For better performance, hit [ENTER] to switch to interactive mode, or
[warn]   consider launching sbt without any commands, or explicitly passing 'shell'
[info] Set current project to scala-docker (in build file:/Users/alextanhongpin/Documents/scala/scala-docker/)

This is a seed project which creates a basic build for an Akka HTTP
application using Scala.

name [My Akka HTTP Project]: scala-docker
scala_version [2.12.4]:
akka_http_version [10.0.11]:
akka_version [2.5.8]:
organization [com.example]:

Template applied in ./scala-docker
```

## Run

```bash
$ cd scala-docker
$ sbt run
```

Output:

```bash
[info] Compiling 4 Scala sources to /Users/alextanhongpin/Documents/scala/scala-docker/scala-docker/target/scala-2.12/classes ...
[info] Non-compiled module 'compiler-bridge_2.12' for Scala 2.12.4. Compiling...
[info]   Compilation completed in 9.292s.
[info] Done compiling.
[info] Packaging /Users/alextanhongpin/Documents/scala/scala-docker/scala-docker/target/scala-2.12/scala-docker_2.12-0.1-SNAPSHOT.jar ...
[info] Done packaging.
[info] Running com.lightbend.akka.http.sample.QuickstartServer
Server online at http://localhost:8080/
Press RETURN to stop...
```

Verify the output:

```bash
$ curl localhost:8080/users
{"users":[]}%
```

## SBT

If you are stuck at the screen...

```bash
$ Getting org.scala-sbt sbt 0.13.8  (this may take some time)...
```

Change the version that matches the version of the sbt installed on your machine. To get the sbt version:
```
$ sbt about
```

Then, at the directory `scala-docker/project/build.properties`, modify the version:

```bash
$ sbt.version=1.0.4
```

## Unresolved Dependencies with scalariform

```
[warn] 	::::::::::::::::::::::::::::::::::::::::::::::
[warn] 	::          UNRESOLVED DEPENDENCIES         ::
[warn] 	::::::::::::::::::::::::::::::::::::::::::::::
[warn] 	:: org.scalariform#sbt-scalariform;1.6.0: not found
[warn] 	::::::::::::::::::::::::::::::::::::::::::::::

[error] (*:update) sbt.librarymanagement.ResolveException: unresolved dependency: org.scalariform#sbt-scalariform;1.6.0: not found
```

Change the `plugins.sbt`:

```
addSbtPlugin("org.scalariform" % "sbt-scalariform" % "1.8.2")
```

## Dockerizing

In `project/plugins.sbt`, add the following dependency:

```
addSbtPlugin("com.typesafe.sbt" % "sbt-native-packager" % "1.2.1")
```

Enable two plugins by adding the lines below to the bottom of `build.sbt`:

```
enablePlugins(JavaAppPackaging)
enablePlugins(DockerPlugin)
```

The first line will enable the default Java Application Archetypes and adds support for other formats (e.g. `.deb` or `.rpm` packages) as well. The second line will enable support for building Docker images. To make it a runnable application, we also need to specify the main class to use in `build.sbt`:

```
mainClass in Compile := 
  Some("com.lightbend.akka.http.sample.QuickstartServer")
```

To build our docker image:

```
$ sbt docker:publishLocal
```

The command will build the project, package it and builds a Docker image called `scala-docker:0.1-SNAPSHOT` on your local Docker server. Before running, change the host from `localhost` to `0.0.0.0` in the main file:


```
Http().bindAndHandle(routes, "0.0.0.0", 8080)
```

Also, we will be using the image below, which is smaller (100+ MB vs 700+ MB). We need to enable the plugin `AshScriptPlugin` too. Alpine doesn't come with **bash** installed, but the startup scripts generated by SBT Native Packager depends on it. Alpine, however, comes with the Almquist Shell (**ash**). This is a much more limited shell than **bash**.


```
dockerBaseImage := "openjdk:jre-alpine"

enablePlugins(AshScriptPlugin)
```

```
$ docker run --rm -p 8080:8080 scala-docker:0.1-SNAPSHOT
```

To check the image generated:

```
docker images | grep scala                       ✓  11246  23:20:40
scala-docker                  0.1-SNAPSHOT        518b50418ee1        13 seconds ago      103MB
```